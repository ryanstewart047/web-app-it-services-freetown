<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Diagnostic Feature</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Test Diagnostic Images & Notes Feature</h1>
        
        <!-- Test Create Booking -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">1. Create Test Booking</h2>
            <button onclick="createTestBooking()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                Create Test Repair
            </button>
            <div id="booking-result" class="mt-4 text-sm"></div>
        </div>

        <!-- Test Update with Diagnostics -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">2. Add Diagnostic Info</h2>
            <input type="text" id="tracking-id-input" placeholder="Enter Tracking ID" class="border rounded px-4 py-2 mr-2 mb-2">
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Diagnostic Notes:</label>
                <textarea id="diagnostic-notes-input" rows="3" class="w-full border rounded px-4 py-2" placeholder="Enter diagnostic notes..."></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Upload Images:</label>
                <input type="file" id="image-input" accept="image/*" multiple class="block">
            </div>
            
            <button onclick="updateWithDiagnostics()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                Add Diagnostic Info
            </button>
            <div id="update-result" class="mt-4 text-sm"></div>
        </div>

        <!-- Test View Booking -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">3. View Customer View</h2>
            <input type="text" id="view-tracking-id" placeholder="Enter Tracking ID" class="border rounded px-4 py-2 mr-2 mb-2">
            <button onclick="viewBooking()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                View as Customer
            </button>
            <div id="view-result" class="mt-4"></div>
        </div>
    </div>

    <script>
        let testTrackingId = null;

        function createTestBooking() {
            const trackingId = `TRK-${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 1000)}`;
            testTrackingId = trackingId;

            const testBooking = {
                trackingId: trackingId,
                customerName: "Test Customer",
                email: "test@example.com",
                phone: "+23230000000",
                deviceType: "iPhone 13",
                deviceModel: "iPhone 13 Pro",
                serviceType: "Screen Replacement",
                issueDescription: "Cracked screen",
                preferredDate: new Date().toISOString().split('T')[0],
                preferredTime: "10:00 AM",
                status: "received",
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Save to localStorage
            const bookings = JSON.parse(localStorage.getItem('its_bookings') || '[]');
            bookings.push(testBooking);
            localStorage.setItem('its_bookings', JSON.stringify(bookings));

            document.getElementById('booking-result').innerHTML = `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                    ‚úÖ Test booking created!<br>
                    <strong>Tracking ID:</strong> <code class="bg-green-200 px-2 py-1 rounded">${trackingId}</code><br>
                    <button onclick="copyToClipboard('${trackingId}')" class="mt-2 text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                        Copy Tracking ID
                    </button>
                </div>
            `;

            // Auto-fill tracking ID in other inputs
            document.getElementById('tracking-id-input').value = trackingId;
            document.getElementById('view-tracking-id').value = trackingId;
        }

        async function updateWithDiagnostics() {
            const trackingId = document.getElementById('tracking-id-input').value;
            const diagnosticNotes = document.getElementById('diagnostic-notes-input').value;
            const imageFiles = document.getElementById('image-input').files;

            if (!trackingId) {
                alert('Please enter a tracking ID');
                return;
            }

            // Convert images to base64
            const diagnosticImages = [];
            for (let i = 0; i < imageFiles.length && i < 5; i++) {
                const file = imageFiles[i];
                const base64 = await fileToBase64(file);
                diagnosticImages.push(base64);
            }

            // Update booking
            const bookings = JSON.parse(localStorage.getItem('its_bookings') || '[]');
            const bookingIndex = bookings.findIndex(b => b.trackingId === trackingId);

            if (bookingIndex === -1) {
                document.getElementById('update-result').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        ‚ùå Booking not found
                    </div>
                `;
                return;
            }

            bookings[bookingIndex] = {
                ...bookings[bookingIndex],
                diagnosticNotes: diagnosticNotes,
                diagnosticImages: diagnosticImages,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('its_bookings', JSON.stringify(bookings));

            document.getElementById('update-result').innerHTML = `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                    ‚úÖ Diagnostic information added!<br>
                    <strong>Notes:</strong> ${diagnosticNotes || 'None'}<br>
                    <strong>Images:</strong> ${diagnosticImages.length} uploaded
                </div>
            `;
        }

        function viewBooking() {
            const trackingId = document.getElementById('view-tracking-id').value;

            if (!trackingId) {
                alert('Please enter a tracking ID');
                return;
            }

            const bookings = JSON.parse(localStorage.getItem('its_bookings') || '[]');
            const booking = bookings.find(b => b.trackingId === trackingId);

            if (!booking) {
                document.getElementById('view-result').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        ‚ùå Booking not found
                    </div>
                `;
                return;
            }

            let html = `
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">üì± ${booking.deviceType}</h3>
                    <p><strong>Customer:</strong> ${booking.customerName}</p>
                    <p><strong>Status:</strong> <span class="capitalize">${booking.status}</span></p>
                    <p><strong>Issue:</strong> ${booking.issueDescription}</p>
            `;

            if (booking.diagnosticNotes) {
                html += `
                    <div class="mt-4 bg-white p-3 rounded border">
                        <h4 class="font-semibold text-blue-800 mb-2">ü©∫ Diagnostic Notes:</h4>
                        <p class="text-gray-700">${booking.diagnosticNotes}</p>
                    </div>
                `;
            }

            if (booking.diagnosticImages && booking.diagnosticImages.length > 0) {
                html += `
                    <div class="mt-4">
                        <h4 class="font-semibold text-blue-800 mb-2">üì∏ Diagnostic Images (${booking.diagnosticImages.length}):</h4>
                        <div class="grid grid-cols-3 gap-2">
                `;

                booking.diagnosticImages.forEach((img, index) => {
                    html += `
                        <img src="${img}" class="w-full h-24 object-cover rounded border cursor-pointer hover:opacity-80" 
                             onclick="window.open('${img}')" 
                             alt="Diagnostic image ${index + 1}">
                    `;
                });

                html += `</div></div>`;
            }

            html += `</div>`;
            document.getElementById('view-result').innerHTML = html;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Tracking ID copied to clipboard!');
            });
        }
    </script>
</body>
</html>
