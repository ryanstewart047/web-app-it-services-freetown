<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Services Freetown - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy': '#040e40'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-3xl font-bold text-navy">Admin Dashboard</h1>
                        <p class="mt-1 text-sm text-gray-500">IT Services Freetown Analytics & Management</p>
                    </div>
                    <button onclick="refreshData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="showTab('overview')" id="tab-overview" class="py-4 px-1 border-b-2 font-medium text-sm border-red-500 text-red-600">
                        Overview
                    </button>
                    <button onclick="showTab('visitors')" id="tab-visitors" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                        Visitors
                    </button>
                    <button onclick="showTab('forms')" id="tab-forms" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                        Form Submissions
                    </button>
                    <button onclick="showTab('repairs')" id="tab-repairs" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                        Repair Tracking
                    </button>
                </nav>
            </div>
        </div>

        <!-- Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Loading State -->
            <div id="loading" class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading analytics...</p>
            </div>

            <!-- Overview Tab -->
            <div id="content-overview" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Total Visitors</h3>
                        <p class="text-3xl font-bold text-red-600" id="total-visitors">0</p>
                        <p class="text-sm text-gray-500 mt-1">Unique: <span id="unique-visitors">0</span></p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Form Submissions</h3>
                        <p class="text-3xl font-bold text-red-600" id="total-submissions">0</p>
                        <p class="text-sm text-gray-500 mt-1">Conversion: <span id="conversion-rate">0</span>%</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Active Repairs</h3>
                        <p class="text-3xl font-bold text-red-600" id="active-repairs">0</p>
                        <p class="text-sm text-gray-500 mt-1">Total: <span id="total-repairs">0</span></p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Revenue</h3>
                        <p class="text-3xl font-bold text-red-600">$<span id="total-revenue">0</span></p>
                        <p class="text-sm text-gray-500 mt-1">Completed repairs</p>
                    </div>
                </div>
            </div>

            <!-- Visitors Tab -->
            <div id="content-visitors" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Visitor Statistics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-navy" id="visitor-total">0</p>
                            <p class="text-sm text-gray-600">Total Visitors</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-navy" id="visitor-unique">0</p>
                            <p class="text-sm text-gray-600">Unique Visitors</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-navy" id="bounce-rate">0</p>
                            <p class="text-sm text-gray-600">Bounce Rate</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-navy" id="avg-session">0</p>
                            <p class="text-sm text-gray-600">Avg Session</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forms Tab -->
            <div id="content-forms" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Form Submissions</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 border border-gray-200 rounded">
                                <p class="text-xl font-bold text-red-600" id="form-submissions">0</p>
                                <p class="text-sm text-gray-600">Total Submissions</p>
                            </div>
                            <div class="text-center p-4 border border-gray-200 rounded">
                                <p class="text-xl font-bold text-red-600" id="form-views">0</p>
                                <p class="text-sm text-gray-600">Total Views</p>
                            </div>
                            <div class="text-center p-4 border border-gray-200 rounded">
                                <p class="text-xl font-bold text-red-600" id="form-conversion">0</p>
                                <p class="text-sm text-gray-600">Conversion Rate</p>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="text-md font-medium text-gray-900 mb-2">Recent Submissions</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tracking ID</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-submissions" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading submissions...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repairs Tab -->
            <div id="content-repairs" class="hidden">
                <div class="space-y-6">
                    <!-- Repair Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Total Repairs</h3>
                            <p class="text-3xl font-bold text-red-600" id="repair-total">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Avg Completion</h3>
                            <p class="text-3xl font-bold text-red-600" id="repair-avg">0</p>
                            <p class="text-sm text-gray-500">days</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Revenue</h3>
                            <p class="text-3xl font-bold text-red-600">$<span id="repair-revenue">0</span></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Status Breakdown</h3>
                            <div id="status-breakdown" class="space-y-1">
                                <p class="text-sm text-gray-500">Loading status data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Repair Management Table -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Repair Management</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tracking ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Device</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cost</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="repair-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading repairs...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Repair Modal -->
    <div id="update-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    Update Repair: <span id="modal-tracking-id"></span>
                </h3>
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="modal-status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                            <option value="submitted">Submitted</option>
                            <option value="diagnosed">Diagnosed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="modal-notes" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Estimated Completion</label>
                        <input type="date" id="modal-completion" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Total Cost ($)</label>
                        <input type="number" id="modal-cost" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="0.00">
                    </div>
                    
                    <!-- New Diagnostic Section -->
                    <div class="border-t pt-4">
                        <h4 class="text-md font-medium text-gray-900 mb-3">Diagnostic Information (Customer View)</h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Diagnostic Notes for Customer</label>
                            <textarea id="modal-diagnostic-notes" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" rows="4" placeholder="e.g., Device inspected. Found cracked screen and damaged battery. Screen replacement in progress..."></textarea>
                            <p class="mt-1 text-xs text-gray-500">This will be visible to the customer when they track their repair</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Diagnostic Images</label>
                            
                            <!-- Mobile Camera Button (only visible on mobile) -->
                            <div id="mobile-camera-section" class="hidden mb-3">
                                <button type="button" onclick="openCamera()" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    Take Photo with Camera
                                </button>
                                <input type="file" id="modal-camera-capture" accept="image/*" capture="environment" class="hidden">
                                <p class="mt-1 text-xs text-gray-500 text-center">Or choose from gallery below</p>
                            </div>
                            
                            <!-- Regular file upload (always visible) -->
                            <input type="file" id="modal-diagnostic-images" accept="image/*" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                            <p class="mt-1 text-xs text-gray-500">Add photos showing the device diagnosis, damage, or repair progress (max 5 images)</p>
                            
                            <!-- Image Preview -->
                            <div id="image-preview-container" class="mt-3 grid grid-cols-3 gap-2"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
           Detect mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768);
        }

        // Show camera option on mobile
        function showCameraOption() {
            if (isMobileDevice()) {
                const cameraSection = document.getElementById('mobile-camera-section');
                if (cameraSection) {
                    cameraSection.classList.remove('hidden');
                }
            }
        }

        // Open camera on mobile
        function openCamera() {
            const cameraInput = document.getElementById('modal-camera-capture');
            if (cameraInput) {
                cameraInput.click();
            }
        }

        // Handle camerprocessImageFiles(files) {
            const maxImages = 5;
            const maxTotalImages = maxImages - uploadedImages.length;
            
            if (files.length + uploadedImages.length > maxImages) {
                alert(`Maximum ${maxImages} images allowed. You can add ${maxTotalImages} more.`);
                return;
            }

            const previewContainer = document.getElementById('image-preview-container');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 2MB per image)
                if (file.size > 2 * 1024 * 1024) {
                    alert(`Image ${file.name} is too large. Maximum size is 2MB`);
                    continue;
                }

                // Convert to base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    uploadedImages.push(base64Image);
                    
                    // Create preview
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative';
                    previewDiv.innerHTML = `
                        <img src="${base64Image}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="removeImage(${uploadedImages.length - 1})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                            ×
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleImageUpload(event) {
            const files = event.target.files;
            await processImageFiles(files);

        async function handleImageUpload(event) {
            const files = event.target.files;
            const maxImages = 5;
            
            if (files.length > maxImages) {
                alert(`Maximum ${maxImages} images allowed`);
                return;
            }

            uploadedImages = [];
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 2MB per image)
                if (file.size > 2 * 1024 * 1024) {
                    alert(`Image ${file.name} is too large. Maximum size is 2MB`);
                    continue;
                }

                // Convert to base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    uploadedImages.push(base64Image);
                    
                    // Create preview
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative';
                    previewDiv.innerHTML = `
                        <img src="${base64Image}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="removeImage(${uploadedImages.length - 1})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                            ×
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = '';
            
            uploadedImages.forEach((img, i) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative';
                previewDiv.innerHTML = `
                    <img src="${img}" class="w-full h-24 object-cover rounded-lg">
                    <button onclick="removeImage(${i})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                        ×
                    </button>
                `;
                previewContainer.appendChild(previewDiv);
            });
        }

        function showTab(tabName) {
            // Hide all content
            const contents = ['overview', 'visitors', 'forms', 'repairs'];
            contents.forEach(content => {
                document.getElementById(`content-${content}`).classList.add('hidden');
                document.getElementById(`tab-${content}`).classList.remove('border-red-500', 'text-red-600');
                document.getElementById(`tab-${content}`).classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('border-red-500', 'text-red-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
        }

        async function fetchData() {
            try {
                const [analyticsRes, formsRes, repairsRes] = await Promise.all([
                    fetch('/api/analytics/visitor/'),
                    fetch('/api/analytics/forms/'),
                    fetch('/api/analytics/repairs/')
                ]);

                if (analyticsRes.ok) {
                    analyticsData = await analyticsRes.json();
                    updateAnalyticsDisplay();
                }

                if (formsRes.ok) {
                    formData = await formsRes.json();
                    updateFormsDisplay();
                }

                if (repairsRes.ok) {
                    repairData = await repairsRes.json();
                    updateRepairsDisplay();
                }

                updateOverview();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function updateOverview() {
            if (analyticsData) {
                document.getElementById('total-visitors').textContent = analyticsData.totalVisitors || 0;
                document.getElementById('unique-visitors').textContent = analyticsData.uniqueVisitors || 0;
            }

            if (formData) {
                document.getElementById('total-submissions').textContent = formData.totalSubmissions || 0;
                document.getElementById('conversion-rate').textContent = formData.overallConversionRate || 0;
            }

            if (repairData) {
                const activeRepairs = (repairData.statusCounts?.['in-progress'] || 0) + (repairData.statusCounts?.['diagnosed'] || 0);
                document.getElementById('active-repairs').textContent = activeRepairs;
                document.getElementById('total-repairs').textContent = repairData.totalRepairs || 0;
                document.getElementById('total-revenue').textContent = repairData.totalRevenue || 0;
            }
        }

        function updateAnalyticsDisplay() {
            if (!analyticsData) return;

            document.getElementById('visitor-total').textContent = analyticsData.totalVisitors || 0;
            document.getElementById('visitor-unique').textContent = analyticsData.uniqueVisitors || 0;
            document.getElementById('bounce-rate').textContent = `${analyticsData.bounceRate || 0}%`;
            document.getElementById('avg-session').textContent = `${analyticsData.avgSessionDuration || 0}min`;
        }

        function updateFormsDisplay() {
            if (!formData) return;

            document.getElementById('form-submissions').textContent = formData.totalSubmissions || 0;
            document.getElementById('form-views').textContent = formData.totalViews || 0;
            document.getElementById('form-conversion').textContent = `${formData.overallConversionRate || 0}%`;

            // Update recent submissions
            const tbody = document.getElementById('recent-submissions');
            tbody.innerHTML = '';

            if (formData.recentSubmissions && formData.recentSubmissions.length > 0) {
                formData.recentSubmissions.forEach(submission => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 capitalize">
                                ${submission.formType}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${submission.timestamp}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            ${submission.fields?.name ? `<div><strong>Name:</strong> ${submission.fields.name}</div>` : ''}
                            ${submission.fields?.email ? `<div><strong>Email:</strong> ${submission.fields.email}</div>` : ''}
                            ${submission.fields?.issue ? `<div><strong>Issue:</strong> ${submission.fields.issue}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${submission.trackingId ? `<span class="text-red-600">${submission.trackingId}</span>` : '-'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No recent submissions</td></tr>';
            }
        }

        function updateRepairsDisplay() {
            if (!repairData) return;

            document.getElementById('repair-total').textContent = repairData.totalRepairs || 0;
            document.getElementById('repair-avg').textContent = repairData.averageCompletionDays || 0;
            document.getElementById('repair-revenue').textContent = repairData.totalRevenue || 0;

            // Update status breakdown
            const statusDiv = document.getElementById('status-breakdown');
            statusDiv.innerHTML = '';

            if (repairData.statusCounts && Object.keys(repairData.statusCounts).length > 0) {
                Object.entries(repairData.statusCounts).forEach(([status, count]) => {
                    const statusItem = document.createElement('div');
                    statusItem.className = 'flex justify-between text-sm';
                    statusItem.innerHTML = `
                        <span class="capitalize text-gray-600">${status}:</span>
                        <span class="font-medium">${count}</span>
                    `;
                    statusDiv.appendChild(statusItem);
                });
            } else {
                statusDiv.innerHTML = '<p class="text-sm text-gray-500">No repairs yet</p>';
            }

            // Update repair list
            const tbody = document.getElementById('repair-list');
            tbody.innerHTML = '';

            if (repairData.allRepairs && repairData.allRepairs.length > 0) {
                repairData.allRepairs.forEach(repair => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                            ${repair.trackingId}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${repair.customerName}</div>
                            <div class="text-sm text-gray-500">${repair.email}</div>
                            <div class="text-sm text-gray-500">${repair.phone}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${repair.deviceType}</div>
                            <div class="text-sm text-gray-500">${repair.issueDescription}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize ${getStatusColor(repair.status)}">
                                ${repair.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${repair.submissionDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${repair.totalCost ? `$${repair.totalCost}` : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openUpdateModal('${repair.trackingId}')" class="text-red-600 hover:text-red-900">
                                Update
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No repairs found. Test repair has been created.</td></tr>';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'bg-green-100 text-green-800';
                case 'in-progress': return 'bg-blue-100 text-blue-800';
                case 'diagnosed': return 'bg-yellow-100 text-yellow-800';
                case 'submitted': return 'bg-gray-100 text-gray-800';
                case 'cancelled': retmodal-camera-capture').value = '';
            document.getElementById('urn 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function openUpdateModal(trackingId) {
            const repair = repairData.allRepairs.find(r => r.trackingId === trackingId);
            if (!repair) return;

            currentRepair = repair;
            uploadedImages = repair.diagnosticImages || [];
            
            document.getElementById('modal-tracking-id').textContent = trackingId;
            document.getElementById('modal-status').value = repair.status;
            document.getElementById('modal-notes').value = repair.notes || '';
            document.getElementById('modal-completion').value = repair.estimatedCompletion || '';
            document.getElementById('modal-cost').value = repair.totalCost || '';
            document.getElementById('modal-diagnostic-notes').value = repair.diagnosticNotes || '';
            
            // Display existing images
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = '';
            
            if (uploadedImages.length > 0) {
                uploadedImages.forEach((img, i) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative';
                    previewDiv.innerHTML = `
                        <img src="${img}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="removeImage(${i})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                            ×
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                });
            }
            
            document.getElementById('update-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('update-modal').classList.add('hidden');
            currentRepair = null;
            uploadedImages = [];
            document.getElementById('modal-diagnostic-images').value = '';
            document.getElementById('image-preview-container').innerHTML = '';
        }

        async function updateRepair() {
            if (!currentRepair) return;

            const updateData = {
                trackingId: currentRepair.trackingId,
                status: document.getElementById('modal-status').value,
                notes: document.getElementById('modal-notes').value,
                estimatedCompletion: document.getElementById('modal-completion').value,
                totalCost: document.getElementById('modal-cost').value ? parseFloat(document.getElementById('modal-cost').value) : undefined,
                diagnosticNotes: document.getElementById('modal-diagnostic-notes').value,
                diagnosticImages: uploadedImages
            };

            try {
                // Update via localStorage directly
                if (typeof Storage !== 'undefined' && window.localStorage) {
                    const bookings = JSON.parse(localStorage.getItem('its_bookings') || '[]');
                    const bookingIndex = bookings.findIndex(b => b.trackingId === currentRepair.trackingId);
                    
                    if (bookingIndex !== -1) {
                        bookings[bookingIndex] = {
                            ...bookings[bookingIndex],
                            status: updateData.status,
                            notes: updateData.notes,
                            estimatedCompletion: updateData.estimatedCompletion,
                            cost: updateData.totalCost,
                            diagnosticNotes: updateData.diagnosticNotes,
                            diagnosticImages: updateData.diagnosticImages,
                            updatedAt: new Date().toISOString()
                        };
                        
                        localStorage.setItem('its_bookings', JSON.stringify(bookings));
                        
                        // Also update export data
                        const exportData = {
                            lastUpdated: new Date().toISOString(),
                            bookings: bookings
                        };
                        localStorage.setItem('its_bookings_export', JSON.stringify(exportData));
                        
                        alert('Repair updated successfully! Customer can now see diagnostic images and notes.');
                        closeModal();
                        await refreshData();
                        return;
                    }
                }

                // Fallback to API if localStorage not available
                const response = await fetch('/api/analytics/repairs/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData),
                });

                if (response.ok) {
                    alert('Repair updated successfully!');
                    closeModal();
                    await refreshData();
                } else {
                    alert('Failed to update repair');
                }
            } catch (error) {
                console.error('Error updating repair:', error);
                alert('Error updating repair');
            }
        }

        async function refreshData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content-overview').classList.add('hidden');
            await fetchData();
            document.getElementById('loading').classList.add('hidden');
            showTab('overview');
        }
    </script>
</body>
</html>